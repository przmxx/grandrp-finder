<script>
    let currentSrv = '8rml8v';
    let allPlayers = [];
    let favorites = JSON.parse(localStorage.getItem('przmx_favs')) || [];
    let showOnlyFavs = false;
    
    // Funkcja sprawdzająca i resetująca dane o północy
    function checkDailyReset() {
        const lastReset = localStorage.getItem('przmx_last_reset_date');
        const today = new Date().toLocaleDateString();

        if (lastReset !== today) {
            // Czyścimy historię, bo mamy nowy dzień
            localStorage.removeItem('przmx_history');
            localStorage.setItem('przmx_last_reset_date', today);
            console.log("System Protocol: Wykonano czyszczenie bazy dziennej.");
            return {};
        }
        return JSON.parse(localStorage.getItem('przmx_history')) || {};
    }

    let playerHistory = checkDailyReset();

    // ... (updateAccentColor i fetchData bez zmian) ...

    function renderList() {
        // Przed każdym renderowaniem upewniamy się, czy nie trzeba zresetować danych (np. jeśli strona jest otwarta całą noc)
        playerHistory = checkDailyReset();

        let filtered = allPlayers.filter(p => p.name.toLowerCase().includes(document.getElementById('search').value.toLowerCase()) || p.id.toString().includes(document.getElementById('search').value));
        if(showOnlyFavs) filtered = filtered.filter(p => favorites.includes(p.name));
        
        document.getElementById('count').innerText = filtered.length;
        const container = document.getElementById('player-list');
        
        container.innerHTML = filtered.map((p, index) => {
            const isGoat = p.name.toLowerCase().includes('przmx') || p.name.toLowerCase().includes('kejcpi');
            const isFav = favorites.includes(p.name);
            
            // Rejestracja w historii przy każdym wykryciu
            const now = new Date().getTime();
            if (!playerHistory[p.name]) {
                playerHistory[p.name] = { 
                    firstSeen: now, 
                    idHistory: [p.id] 
                };
            } else if (!playerHistory[p.name].idHistory.includes(p.id)) {
                playerHistory[p.name].idHistory.push(p.id);
            }
            localStorage.setItem('przmx_history', JSON.stringify(playerHistory));

            return `
                <div class="neo-card p-6 rounded-2xl flex items-center justify-between group card-anim" style="animation-delay: ${index * 0.03}s" onclick='openModal(${JSON.stringify(p).replace(/'/g, "&apos;")})'>
                    <div class="flex flex-col gap-1 min-w-0">
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-black ${isGoat ? 'text-white' : 'text-white/30'} uppercase tracking-[0.2em] mb-1">${isGoat ? 'NICK GOATA' : 'NICK CWELA'}</span>
                            <svg onclick="event.stopPropagation(); toggleFav('${p.name}')" class="fav-star ${isFav ? 'active' : ''}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        </div>
                        <h3 class="text-2xl font-bold ${isGoat ? 'text-white underline decoration-2 underline-offset-4' : 'text-slate-200'} truncate pr-4">${p.name}</h3>
                    </div>
                    <div class="flex flex-col items-end shrink-0">
                        <span class="text-[10px] font-bold text-white/10 uppercase mb-1">ID</span>
                        <span class="text-4xl font-black italic" style="color: ${isGoat ? '#fff' : 'var(--accent-color)'}">${p.id}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function openModal(player) {
        const history = playerHistory[player.name];
        const now = new Date().getTime();
        const durationMin = Math.round((now - history.firstSeen) / 60000);
        const startTime = new Date(history.firstSeen).toLocaleTimeString();

        document.getElementById('modalName').innerText = player.name;
        document.getElementById('modalID').innerText = `ID: ${player.id}`;
        document.getElementById('modalDuration').innerText = `${durationMin} min`;
        
        const logContainer = document.getElementById('modalLogs');
        logContainer.innerHTML = `
            <div class="log-item">
                <span class="text-[9px] text-white/30 uppercase block">Pierwszy kontakt dzisiaj</span>
                <span class="text-sm font-bold text-white">${startTime}</span>
            </div>
            <div class="log-item">
                <span class="text-[9px] text-white/30 uppercase block">Historia ID</span>
                <span class="text-sm font-bold text-blue-400">${history.idHistory.join(' → ')}</span>
            </div>
            ${history.idHistory.length > 1 ? `
                <div class="text-[9px] text-yellow-500 font-bold uppercase text-center mt-2 animate-pulse">
                    ⚠ Wykryto zmianę ID
                </div>
            ` : ''}
        `;

        document.getElementById('overlay').style.display = 'flex';
    }

    // ... (pozostałe funkcje bez zmian) ...
</script>
